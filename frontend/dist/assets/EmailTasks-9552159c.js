import{H as h,_ as ie,r as g,J as Y,c as ue,o as de,Q as d,b as s,ab as me,d as m,e as V,f as C,i as t,w as a,C as pe,l as B,k as ce,R as fe,j as r,t as b,h as L,F as R,g as S,P as I}from"./index-dc0220d7.js";function _e(i){return h({url:"/api/admin/email-tasks",method:"get",params:i})}function ye(i){return h({url:"/api/admin/email-tasks",method:"post",data:i})}function ge(i,v){return h({url:`/api/admin/email-tasks/${i}`,method:"put",data:v})}function be(i){return h({url:`/api/admin/email-tasks/${i}`,method:"delete"})}function ve(i){return h({url:`/api/admin/email-tasks/${i}/send`,method:"post"})}const ke={class:"email-tasks-container"},Ve={class:"header"},he={class:"form-tip"},we=["onClick"],Ce={class:"form-tip"},Te=["onClick"],xe={__name:"EmailTasks",setup(i){const v=g(!1),D=g([]),k=Y({type:""}),f=g(!1),T=g("新增任务"),x=g(null),E=g(!1),o=Y({id:null,name:"",type:"register",subject:"",content:"",status:1,schedule_time:""}),A={name:[{required:!0,message:"请输入任务名称",trigger:"blur"}],type:[{required:!0,message:"请选择任务类型",trigger:"change"}],subject:[{required:!0,message:"请输入邮件标题",trigger:"blur"}],content:[{required:!0,message:"请输入邮件内容",trigger:"blur"}]},J={register:{"{username}":"用户名称","{email}":"用户邮箱"},order:{"{username}":"用户名称","{order_no}":"订单号","{amount}":"订单金额"},holiday:{"{username}":"用户名称"}},$=ue(()=>J[o.type]||{});de(()=>{w()});const w=async()=>{v.value=!0;try{const n={};k.type&&(n.type=k.type);const e=await _e(n);D.value=e.data.data||[]}catch{d.error("获取数据失败")}finally{v.value=!1}},O=()=>{w()},P=()=>{T.value="新增任务",M(),f.value=!0},Q=n=>{T.value="编辑任务",Object.assign(o,n),f.value=!0},z=async()=>{await x.value.validate(),E.value=!0;try{o.id?(await ge(o.id,o),d.success("更新成功")):(await ye(o),d.success("创建成功")),f.value=!1,w()}catch(n){d.error(n.message||"操作失败")}finally{E.value=!1}},G=async n=>{try{await I.confirm("确定要删除此任务吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await be(n.id),d.success("删除成功"),w()}catch(e){e!=="cancel"&&d.error("删除失败")}},K=async n=>{try{await I.confirm("确定要立即发送邮件给所有用户吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=await ve(n.id);d.success(e.data.message||"发送成功")}catch(e){e!=="cancel"&&d.error(e.message||"发送失败")}},W=()=>{},U=(n,e)=>{o[n]+=e},M=()=>{var n;o.id=null,o.name="",o.type="register",o.subject="",o.content="",o.status=1,o.schedule_time="",(n=x.value)==null||n.clearValidate()},X=n=>({register:"注册欢迎",order:"下单确认",holiday:"节假日/新品"})[n]||n,Z=n=>({register:"primary",order:"warning",holiday:"success"})[n]||"info";return(n,e)=>{const ee=s("el-icon"),_=s("el-button"),p=s("el-option"),q=s("el-select"),c=s("el-form-item"),F=s("el-form"),te=s("el-card"),y=s("el-table-column"),H=s("el-tag"),le=s("el-table"),j=s("el-input"),N=s("el-radio"),ae=s("el-radio-group"),oe=s("el-date-picker"),ne=s("el-dialog"),se=me("loading");return m(),V("div",ke,[C("div",Ve,[e[10]||(e[10]=C("h2",null,"邮件任务管理",-1)),t(_,{type:"primary",onClick:P},{default:a(()=>[t(ee,null,{default:a(()=>[t(ce(fe))]),_:1}),e[9]||(e[9]=r(" 新增任务 ",-1))]),_:1})]),t(te,{class:"filter-card"},{default:a(()=>[t(F,{inline:!0,model:k},{default:a(()=>[t(c,{label:"任务类型"},{default:a(()=>[t(q,{modelValue:k.type,"onUpdate:modelValue":e[0]||(e[0]=l=>k.type=l),placeholder:"全部",clearable:"",onChange:O,style:{width:"180px"}},{default:a(()=>[t(p,{label:"全部",value:""}),t(p,{label:"注册欢迎",value:"register"}),t(p,{label:"下单确认",value:"order"}),t(p,{label:"节假日/新品",value:"holiday"})]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1}),pe((m(),B(le,{data:D.value,style:{width:"100%"}},{default:a(()=>[t(y,{prop:"id",label:"ID",width:"80"}),t(y,{prop:"name",label:"任务名称","min-width":"150"}),t(y,{label:"任务类型",width:"120"},{default:a(({row:l})=>[t(H,{type:Z(l.type)},{default:a(()=>[r(b(X(l.type)),1)]),_:2},1032,["type"])]),_:1}),t(y,{prop:"subject",label:"邮件标题","min-width":"200","show-overflow-tooltip":""}),t(y,{label:"状态",width:"100"},{default:a(({row:l})=>[t(H,{type:l.status===1?"success":"info"},{default:a(()=>[r(b(l.status===1?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),t(y,{label:"操作",width:"220",fixed:"right"},{default:a(({row:l})=>[t(_,{link:"",type:"primary",onClick:u=>Q(l)},{default:a(()=>[...e[11]||(e[11]=[r("编辑",-1)])]),_:1},8,["onClick"]),l.type==="holiday"?(m(),B(_,{key:0,link:"",type:"success",onClick:u=>K(l)},{default:a(()=>[...e[12]||(e[12]=[r("发送",-1)])]),_:1},8,["onClick"])):L("",!0),t(_,{link:"",type:"danger",onClick:u=>G(l)},{default:a(()=>[...e[13]||(e[13]=[r("删除",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[se,v.value]]),t(ne,{modelValue:f.value,"onUpdate:modelValue":e[8]||(e[8]=l=>f.value=l),title:T.value,width:"800px",onClose:M},{footer:a(()=>[t(_,{onClick:e[7]||(e[7]=l=>f.value=!1)},{default:a(()=>[...e[18]||(e[18]=[r("取消",-1)])]),_:1}),t(_,{type:"primary",onClick:z,loading:E.value},{default:a(()=>[...e[19]||(e[19]=[r("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[t(F,{model:o,rules:A,ref_key:"formRef",ref:x,"label-width":"120px"},{default:a(()=>[t(c,{label:"任务名称",prop:"name"},{default:a(()=>[t(j,{modelValue:o.name,"onUpdate:modelValue":e[1]||(e[1]=l=>o.name=l),placeholder:"请输入任务名称"},null,8,["modelValue"])]),_:1}),t(c,{label:"任务类型",prop:"type"},{default:a(()=>[t(q,{modelValue:o.type,"onUpdate:modelValue":e[2]||(e[2]=l=>o.type=l),placeholder:"请选择任务类型",style:{width:"100%"},onChange:W},{default:a(()=>[t(p,{label:"注册欢迎",value:"register"}),t(p,{label:"下单确认",value:"order"}),t(p,{label:"节假日/新品",value:"holiday"})]),_:1},8,["modelValue"])]),_:1}),t(c,{label:"邮件标题",prop:"subject"},{default:a(()=>[t(j,{modelValue:o.subject,"onUpdate:modelValue":e[3]||(e[3]=l=>o.subject=l),placeholder:"请输入邮件标题"},null,8,["modelValue"]),C("div",he,[e[14]||(e[14]=r(" 可用变量： ",-1)),(m(!0),V(R,null,S($.value,(l,u)=>(m(),V("span",{key:u,class:"variable-tag",onClick:re=>U("subject",u)},b(u)+" ("+b(l)+") ",9,we))),128))])]),_:1}),t(c,{label:"邮件内容",prop:"content"},{default:a(()=>[t(j,{modelValue:o.content,"onUpdate:modelValue":e[4]||(e[4]=l=>o.content=l),type:"textarea",rows:10,placeholder:"请输入邮件内容（支持HTML）",id:"content-input"},null,8,["modelValue"]),C("div",Ce,[e[15]||(e[15]=r(" 可用变量： ",-1)),(m(!0),V(R,null,S($.value,(l,u)=>(m(),V("span",{key:u,class:"variable-tag",onClick:re=>U("content",u)},b(u)+" ("+b(l)+") ",9,Te))),128))])]),_:1}),t(c,{label:"状态",prop:"status"},{default:a(()=>[t(ae,{modelValue:o.status,"onUpdate:modelValue":e[5]||(e[5]=l=>o.status=l)},{default:a(()=>[t(N,{label:1},{default:a(()=>[...e[16]||(e[16]=[r("启用",-1)])]),_:1}),t(N,{label:0},{default:a(()=>[...e[17]||(e[17]=[r("禁用",-1)])]),_:1})]),_:1},8,["modelValue"])]),_:1}),o.type==="holiday"?(m(),B(c,{key:0,label:"计划发送时间",prop:"schedule_time"},{default:a(()=>[t(oe,{modelValue:o.schedule_time,"onUpdate:modelValue":e[6]||(e[6]=l=>o.schedule_time=l),type:"datetime",placeholder:"选择发送时间",style:{width:"100%"},"value-format":"YYYY-MM-DD HH:mm:ss"},null,8,["modelValue"])]),_:1})):L("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},je=ie(xe,[["__scopeId","data-v-0f7b3e4f"]]);export{je as default};
