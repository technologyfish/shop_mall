import{_ as me,u as ve,I as _e,a as fe,r as v,c as V,J as ye,o as ge,z as he,Q as g,b as w,d as r,e as u,f as s,i as o,w as d,t as n,h as _,l as J,F as Q,g as Y,j as f,n as ke,A as Z,k as ee,R as se,P as we}from"./index-dc0220d7.js";import{u as be}from"./cart-5154d6d7.js";import{g as Ce,u as Ve,a as Ae,d as Fe}from"./address-33c3bea3.js";import{c as xe}from"./order-cd7f84b2.js";import{a as qe}from"./product-3eb05e62.js";import{g as Ie}from"./shipping-cb1b4a6b.js";const Se={class:"order-create-page"},Oe={class:"container"},Pe={class:"checkout-grid"},Ne={class:"main-col"},Ue={class:"section-card address-section"},Be={class:"section-header"},De={key:0,class:"address-display"},Re={class:"addr-info"},ze={class:"name-row"},Ee={class:"name"},$e={class:"phone"},Me={key:0,class:"email"},Te={class:"detail"},je={key:1,class:"city-postal"},Le={key:0},Je={key:1},Qe={class:"section-card items-section"},Ge={class:"order-items"},He=["src"],Ke={class:"item-info"},We={class:"sku"},Xe={class:"item-price"},Ye={class:"sidebar-col"},Ze={class:"summary-card"},es={class:"summary-row"},ss={key:0,class:"summary-row"},ts={key:1,class:"summary-row"},as={key:2,class:"summary-row discount"},ls={style:{color:"#67c23a"}},os={class:"summary-row total"},ds={class:"address-dialog-content"},rs={class:"address-list"},is=["onClick"],ns={class:"address-info"},us={class:"name-row"},cs={class:"name"},ps={class:"phone"},ms={key:0,class:"email"},vs={class:"address-text"},_s={key:1,class:"city-postal"},fs={key:0},ys={key:1,style:{"margin-left":"10px"}},gs={class:"address-actions"},hs={key:1,class:"empty-address"},ks={__name:"OrderCreate",setup(ws){const D=ve(),N=_e(),A=be(),R=fe(),k=v([]),c=v(null),z=v(!1),F=v(!1),b=v(!1),x=v(null),q=v(null),E=v(!1),$=v(!1),U=v(0),G=v([]),I=v(!1),B=V(()=>{if(I.value)return G.value;const l=JSON.parse(localStorage.getItem("checkout_cart_ids")||"[]");return l.length>0?A.cartItems.filter(e=>l.includes(e.id)):A.cartItems}),S=V(()=>B.value.reduce((l,e)=>{var t;return l+(((t=e.product)==null?void 0:t.price)||0)*e.quantity},0)),M=V(()=>{if(!x.value||S.value===0)return 0;const l=x.value;return!l.shipping_fee||parseFloat(l.shipping_fee)===0||l.free_shipping_threshold&&parseFloat(l.free_shipping_threshold)>0&&S.value>=parseFloat(l.free_shipping_threshold)?0:parseFloat(l.shipping_fee)}),T=V(()=>!$.value||U.value<=0?0:S.value*(U.value/100)),te=V(()=>S.value+M.value-T.value),j=v(null),i=ye({name:"",email:"",phone:"",address:"",city:"",postal_code:"",is_default:!1}),ae={name:[{required:!0,message:"Full Name is required",trigger:"blur"}],email:[{required:!0,message:"Email is required",trigger:"blur"},{type:"email",message:"Invalid email format",trigger:"blur"}],phone:[{required:!0,message:"Phone is required",trigger:"blur"}],address:[{required:!0,message:"Shipping Address is required",trigger:"blur"}],city:[{required:!0,message:"City is required",trigger:"blur"}],postal_code:[{required:!0,message:"Postal Code is required",trigger:"blur"}]};ge(async()=>{var l,e;try{const t=await Ie();x.value=t.data.data}catch(t){console.error("Failed to load shipping settings:",t)}try{if(R.isLoggedIn&&(await R.fetchUserInfo(),((l=R.userInfo)==null?void 0:l.first_order_discount)===1)){const t=await he.get("/api/off-code/promotion");(e=t.data.data)!=null&&e.active&&($.value=!0,U.value=t.data.data.discount_value)}}catch(t){console.error("Failed to check first order discount:",t)}if(N.query.type==="buynow"&&N.query.productId){I.value=!0;try{const t=parseInt(N.query.productId),y=parseInt(N.query.quantity)||1,C=(await qe(t)).data.data;G.value=[{id:t,product_id:t,product:C,quantity:y}]}catch{g.error("Failed to load product"),D.push("/shop");return}}else if(I.value=!1,await A.fetchCart(),JSON.parse(localStorage.getItem("checkout_cart_ids")||"[]").length===0&&A.cartItems.length===0){g.warning("Cart is empty"),D.push("/cart");return}await L()});const L=async()=>{try{const l=await Ce();k.value=l.data.data||[];const e=k.value.find(t=>t.is_default);e?c.value=e.id:k.value.length>0&&(c.value=k.value[0].id)}catch(l){console.error(l)}},p=V(()=>k.value.find(l=>l.id===c.value)),le=()=>{F.value=!0},oe=l=>{c.value=l},de=()=>{c.value&&(F.value=!1,g.success("Address selected"))},H=()=>{q.value=null,Object.assign(i,{name:"",email:"",phone:"",address:"",city:"",postal_code:"",is_default:!1}),b.value=!0},re=l=>{q.value=l,Object.assign(i,{name:l.name||"",email:l.email||"",phone:l.phone||"",address:l.address||"",city:l.city||"",postal_code:l.postal_code||"",is_default:l.is_default||!1}),b.value=!0},ie=async()=>{j.value&&await j.value.validate(async l=>{var e,t;if(l){E.value=!0;try{if(q.value?(await Ve(q.value.id,i),g.success("Address updated")):(await Ae(i),g.success("Address added")),b.value=!1,await L(),i.is_default){const y=k.value.find(O=>O.is_default);y&&(c.value=y.id)}}catch(y){g.error(((t=(e=y.response)==null?void 0:e.data)==null?void 0:t.message)||"Failed to save address")}finally{E.value=!1}}})},ne=async l=>{try{await we.confirm("确定要删除这个地址吗？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Fe(l),g.success("Address deleted"),await L(),c.value===l&&(c.value=null)}catch(e){e!=="cancel"&&g.error("Failed to delete address")}},ue=async()=>{var l,e;if(!c.value){g.warning("Please select an address");return}z.value=!0;try{const t=k.value.find(m=>m.id===c.value);if(!t)throw new Error("Address not found");const y=B.value.map(m=>{var h;return{product_id:m.product_id||((h=m.product)==null?void 0:h.id)||m.id,quantity:m.quantity}}),C=(await xe({items:y,ship_name:t.name,ship_email:t.email,ship_phone:t.phone,ship_address:t.address,ship_city:t.city,ship_postal_code:t.postal_code,remark:"",clear_cart:!I.value})).data.data;g.success("Order created successfully! Redirecting to payment..."),I.value||await A.fetchCart(),setTimeout(()=>{D.push(`/payment/${C.id}`)},500)}catch(t){console.error(t),g.error(((e=(l=t.response)==null?void 0:l.data)==null?void 0:e.message)||t.message||"Failed to place order")}finally{z.value=!1}};return(l,e)=>{const t=w("el-button"),y=w("el-tag"),O=w("el-empty"),C=w("el-dialog"),m=w("el-input"),h=w("el-form-item"),ce=w("el-switch"),pe=w("el-form");return r(),u("div",Se,[s("div",Oe,[e[22]||(e[22]=s("h1",{class:"page-title"},"Checkout",-1)),s("div",Pe,[s("div",Ne,[s("div",Ue,[s("div",Be,[e[12]||(e[12]=s("h2",null,"Shipping Address",-1)),o(t,{link:"",type:"primary",onClick:le},{default:d(()=>[...e[11]||(e[11]=[f(" Select / Manage Address ",-1)])]),_:1})]),p.value?(r(),u("div",De,[s("div",Re,[s("div",ze,[s("span",Ee,n(p.value.name),1),s("span",$e,n(p.value.phone),1)]),p.value.email?(r(),u("div",Me,n(p.value.email),1)):_("",!0),s("div",Te,n(p.value.address),1),p.value.city||p.value.postal_code?(r(),u("div",je,[p.value.city?(r(),u("span",Le,n(p.value.city),1)):_("",!0),p.value.postal_code?(r(),u("span",Je,n(p.value.postal_code),1)):_("",!0)])):_("",!0)]),p.value.is_default?(r(),J(y,{key:0,size:"small",type:"success",class:"mt-2"},{default:d(()=>[...e[13]||(e[13]=[f("Default",-1)])]),_:1})):_("",!0)])):(r(),J(O,{key:1,description:"No address selected. Please add or select one."}))]),s("div",Qe,[e[14]||(e[14]=s("h2",null,"Order Items",-1)),s("div",Ge,[(r(!0),u(Q,null,Y(B.value,a=>{var P,K,W,X;return r(),u("div",{key:a.id,class:"item-row"},[s("img",{src:((P=a.product)==null?void 0:P.image)||((K=a.product)==null?void 0:K.main_image)||"/placeholder-product.jpg",class:"item-img"},null,8,He),s("div",Ke,[s("h3",null,n((W=a.product)==null?void 0:W.name),1),s("p",We,"Qty: "+n(a.quantity),1)]),s("div",Xe," ¥"+n((((X=a.product)==null?void 0:X.price)*a.quantity).toFixed(2)),1)])}),128))])])]),s("div",Ye,[s("div",Ze,[e[20]||(e[20]=s("h2",null,"Order Summary",-1)),s("div",es,[e[15]||(e[15]=s("span",null,"Subtotal",-1)),s("span",null,"£"+n(S.value.toFixed(2)),1)]),M.value>0?(r(),u("div",ss,[e[16]||(e[16]=s("span",null,"Shipping",-1)),s("span",null,"£"+n(M.value.toFixed(2)),1)])):x.value&&x.value.shipping_fee>0?(r(),u("div",ts,[...e[17]||(e[17]=[s("span",null,"Shipping",-1),s("span",{style:{color:"#67c23a"}},"Free",-1)])])):_("",!0),$.value&&T.value>0?(r(),u("div",as,[s("span",null,"First Order Discount ("+n(U.value)+"%)",1),s("span",ls,"-£"+n(T.value.toFixed(2)),1)])):_("",!0),e[21]||(e[21]=s("div",{class:"divider"},null,-1)),s("div",os,[e[18]||(e[18]=s("span",null,"Total",-1)),s("span",null,"£"+n(te.value.toFixed(2)),1)]),o(t,{type:"primary",class:"btn-submit",size:"large",loading:z.value,onClick:ue,disabled:!c.value||B.value.length===0},{default:d(()=>[...e[19]||(e[19]=[f(" Place Order ",-1)])]),_:1},8,["loading","disabled"])])])])]),o(C,{modelValue:F.value,"onUpdate:modelValue":e[1]||(e[1]=a=>F.value=a),title:"常用地址",width:"480px","close-on-click-modal":!1,class:"address-select-dialog","align-center":""},{footer:d(()=>[o(t,{onClick:e[0]||(e[0]=a=>F.value=!1)},{default:d(()=>[...e[30]||(e[30]=[f("取消",-1)])]),_:1}),o(t,{type:"primary",onClick:de,disabled:!c.value},{default:d(()=>[...e[31]||(e[31]=[f(" 确定 ",-1)])]),_:1},8,["disabled"])]),default:d(()=>[s("div",ds,[k.value.length>0?(r(),u(Q,{key:0},[s("div",rs,[(r(!0),u(Q,null,Y(k.value,a=>(r(),u("div",{key:a.id,class:ke(["address-item",{selected:c.value===a.id}]),onClick:P=>oe(a.id)},[s("div",ns,[s("div",us,[s("span",cs,n(a.name),1),s("span",ps,n(a.phone),1),a.is_default?(r(),J(y,{key:0,size:"small",type:"success",style:{"margin-left":"10px"}},{default:d(()=>[...e[23]||(e[23]=[f("Default",-1)])]),_:1})):_("",!0)]),a.email?(r(),u("div",ms,n(a.email),1)):_("",!0),s("div",vs,n(a.address),1),a.city||a.postal_code?(r(),u("div",_s,[a.city?(r(),u("span",fs,n(a.city),1)):_("",!0),a.postal_code?(r(),u("span",ys,n(a.postal_code),1)):_("",!0)])):_("",!0)]),s("div",gs,[o(t,{link:"",type:"primary",size:"small",onClick:Z(P=>re(a),["stop"])},{default:d(()=>[...e[24]||(e[24]=[f(" 编辑 ",-1)])]),_:1},8,["onClick"]),o(t,{link:"",type:"danger",size:"small",onClick:Z(P=>ne(a.id),["stop"])},{default:d(()=>[...e[25]||(e[25]=[f(" 删除 ",-1)])]),_:1},8,["onClick"])])],10,is))),128))]),o(t,{type:"primary",class:"add-address-btn",onClick:H,icon:ee(se)},{default:d(()=>[...e[26]||(e[26]=[f(" 添加新地址 ",-1)])]),_:1},8,["icon"])],64)):(r(),u("div",hs,[e[28]||(e[28]=s("div",{class:"empty-icon"},[s("svg",{viewBox:"0 0 100 100",width:"80",height:"80",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[s("rect",{x:"20",y:"25",width:"60",height:"50",rx:"4",stroke:"#dcdfe6","stroke-width":"2"}),s("path",{d:"M20 35 L50 55 L80 35",stroke:"#dcdfe6","stroke-width":"2"}),s("circle",{cx:"50",cy:"70",r:"3",fill:"#dcdfe6"})])],-1)),e[29]||(e[29]=s("p",{class:"empty-text"},"暂无收货地址",-1)),o(t,{type:"primary",onClick:H,icon:ee(se)},{default:d(()=>[...e[27]||(e[27]=[f(" 添加新地址 ",-1)])]),_:1},8,["icon"])]))])]),_:1},8,["modelValue"]),o(C,{modelValue:b.value,"onUpdate:modelValue":e[10]||(e[10]=a=>b.value=a),title:q.value?"编辑地址":"添加地址",width:"500px","close-on-click-modal":!1},{footer:d(()=>[o(t,{onClick:e[9]||(e[9]=a=>b.value=!1)},{default:d(()=>[...e[32]||(e[32]=[f("取消",-1)])]),_:1}),o(t,{type:"primary",onClick:ie,loading:E.value},{default:d(()=>[...e[33]||(e[33]=[f(" 保存 ",-1)])]),_:1},8,["loading"])]),default:d(()=>[o(pe,{ref_key:"addressFormRef",ref:j,model:i,rules:ae,"label-width":"120px"},{default:d(()=>[o(h,{label:"Full Name",prop:"name"},{default:d(()=>[o(m,{modelValue:i.name,"onUpdate:modelValue":e[2]||(e[2]=a=>i.name=a),placeholder:"Full Name"},null,8,["modelValue"])]),_:1}),o(h,{label:"Email",prop:"email"},{default:d(()=>[o(m,{modelValue:i.email,"onUpdate:modelValue":e[3]||(e[3]=a=>i.email=a),placeholder:"Email"},null,8,["modelValue"])]),_:1}),o(h,{label:"Phone",prop:"phone"},{default:d(()=>[o(m,{modelValue:i.phone,"onUpdate:modelValue":e[4]||(e[4]=a=>i.phone=a),placeholder:"Phone"},null,8,["modelValue"])]),_:1}),o(h,{label:"Shipping Address",prop:"address"},{default:d(()=>[o(m,{modelValue:i.address,"onUpdate:modelValue":e[5]||(e[5]=a=>i.address=a),type:"textarea",rows:3,placeholder:"Shipping Address"},null,8,["modelValue"])]),_:1}),o(h,{label:"City",prop:"city"},{default:d(()=>[o(m,{modelValue:i.city,"onUpdate:modelValue":e[6]||(e[6]=a=>i.city=a),placeholder:"City"},null,8,["modelValue"])]),_:1}),o(h,{label:"Postal Code",prop:"postal_code"},{default:d(()=>[o(m,{modelValue:i.postal_code,"onUpdate:modelValue":e[7]||(e[7]=a=>i.postal_code=a),placeholder:"Postal Code"},null,8,["modelValue"])]),_:1}),o(h,{label:"设为默认"},{default:d(()=>[o(ce,{modelValue:i.is_default,"onUpdate:modelValue":e[8]||(e[8]=a=>i.is_default=a)},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},qs=me(ks,[["__scopeId","data-v-3748d362"]]);export{qs as default};
